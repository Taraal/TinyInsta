<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Post Example</title>
<meta charset="utf-8">


<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
<script defer
	src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>

<meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="17241782294-ltp2t4hida9csuvq6513nlq57addkuqe.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>


</head>
<body>
	
		
<script>	

function fetchEmail(){
	console.log("lol");
	fetch('/getSession')
		.then(response => response.text())
		.then(data => {
			me = data
		})
}

var me = ""

var SearchBox = {
		search:"",
		  view: function() {
		    return m("form", {
		      onsubmit: function(e) {
		        e.preventDefault()
		        MyPost.postMessage()
		      }}, 
		      [
		    	m('div', {class:'field'},[
		         m("label", {class:'label'},"Search for someone"),
		         m('div',{class:'control'}, m("input[type=text]", {
		          class:'input is-rounded',
		          placeholder:"Someone, something, somewhere...",
		             oninput: function(e) {PostForm.url = e.target.value}})),
		        ])
		    ])
		  }
		}


var PostForm = {
		url:"",
		body:"",
		  view: function() {
		    return m("form", {
		      onsubmit: function(e) {
		        e.preventDefault()
				if (url="") {url="https://dummyimage.com/320x200/000/fff&text="+Date.now()} 
				if (body="") {body="bla bla bla \n"+Date.now()}
		        MyPost.postMessage()
		      }}, 
		      [
		    	m('div', {class:'field'},[
		         m("label", {class:'label'},"URL"),
		         m('div',{class:'control'}, m("input[type=text]", {
		          class:'input is-rounded',
		          placeholder:"Your url",
		             oninput: function(e) {PostForm.url = e.target.value}})),
//		         m("img",{"src":this.url}),
		        ]),
		      m('div',{class:'field'},[
		    	  m("label", {class: 'label'},"Body"),
		          m('div',{class:'control'},m("input[type=textarea]", {
		        class:'textarea',
		        placeholder:"your text",
		        oninput: function(e) { PostForm.body = e.target.value }})),
		        ]),
		      m('div',{class:'control'},m("button[type=submit]", {class:'button is-link'},"Post")),
		    ])
		  }
		}


// TODO : Rendre loadList async pour récup les posts dès le début 
var MyPost = {
		oninit: fetchEmail(), 
		list: [],
	    nextToken: "",
	    loadList: function() {
	        return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/mypost/"+me, 
	            })
	        .then(function(result) {
	        	console.log("list:",result)
	        	MyPost.list=result.items
	            if ('nextPageToken' in result) {
		        	MyPost.nextToken= result.nextPageToken
	            } else {
	            	MyPost.nextToken=""
	            }})
	    },
	    next: function() {
	        return m.request({
	            method: "GET",
	            url: "_ah/api/myApi/v1/mypost/"+ getSession(function(){
	            	return this.responseText;
	            }) +"?next="+MyPost.nextToken})
	        .then(function(result) {
	        	console.log("got:",result)
	        	result.items.map(function(item){MyPost.list.push(item)})
	            if ('nextPageToken' in result) {
		        	MyPost.nextToken= result.nextPageToken
	            } else {
	            	MyPost.nextToken=""
	            }})
	    },
 	    postMessage: function() {
 			var data={'owner': me,
 					'url':PostForm.url,
 					'body':PostForm.body}
     		return m.request({
         		method: "POST",
         		url: "_ah/api/myApi/v1/postMessage",
             	params: data,
         	})
  	    	.then(function(result) {
     	 			console.log("post:",result)
     	 			MyPost.loadList()
         	 	})
     	}
}



var PostView = {
  oninit: MyPost.loadList,
  view: function() {
   	return m('div', [
	  m('div',{class:'subtitle'},"My Posts"),
	  m('table', {class:'table is-striped',"table":"is-striped"},[
	    m('tr', [
		  m('th', {width:"50px"}, "Like"),
		  m('th', {width:"50px"}, "Dislike"),
		  m('th', {width:"50px"}, "Del"),
	      m('th', {width:"50px"}, "Bodys"),
	      m('th', {width:"50px"}, "Urls"),
	      m('th', {width:"50px"}, "Like"),
	      m('th', {width:"50px"}, "Follow"),
	    ]),
	    MyPost.list.map(function(item) {
		      return m("tr", [
	            m("td", m("button", {onclick: function(e) {
					// +1 like au clic si pas déjà liké            	            	
	            	return m.request({
						method: "POST",
						url: "_ah/api/myApi/v1/ajouterLike",
						params: {"idPost":item.key.id, 
							"id_post":item.properties.id_post, 
							"owner":me},
					})
	                 }},"like")),
	                 
               m("td", m("button", {onclick: function(e) {
	           	// -1 like au clic si déjà liké            	            	
	            	return m.request({
						method: "POST",
						url: "_ah/api/myApi/v1/supprimerLike",
						params: {"idPost":item.key.id, 
							"id_post":item.properties.id_post, 
							"owner":getEmail()},
	     				})
	                  }},"dislike")),
                 m("td", m("button", {onclick: function(e) {
     				console.log("del:"+keyToString(item.key))
                 }},"del")),
	        m('td', m('label', item.properties.body)),
	        m('td', m('img', {class: 'is-rounded', 'src': item.properties.url})),
	        m('td', m('label', item.properties.likec)),

            m("td", m("button", {onclick: function(e) {
				// +1 like au clic si pas déjà liké            	            	
            	return m.request({
					method: "PUT",
					url: "_ah/api/myApi/v1/follow/"+me+"/"+item.properties.owner,
					params: {},
				})
                 }},"Follow")),
	    ])}),
//	    m("div", isError ? "An error occurred" : "Saved"),
	    m('button',{
		      class: 'button is-link',
		      onclick: function(e) {MyPost.next()}
		      },
		  "Next"),
	   ])
	 ])
  }
}

function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      console.log('User signed out.');
    });
    window.location.replace("byebye.html");
  }

  function onLoad() {
      gapi.load('auth2', function() {
        gapi.auth2.init();
      });
    }  
  
  
var Hello = {
   view: function() {
   	return m('div', {class:'container'}, [
   		
   		/*m.element('header',{
   		  controller:function(){},
   		  view: function(ctrl){
   		    return m('$header#header', [
   					m('h1', 'todos')
   				])
   		  }
   		})*/
   		   
           m("h1", {class: 'title'}, 'TinyGram'),
		   

           
           m("button", {onclick: function() {
        	   signOut();
        	   window.location.replace("authen.html");
        	   
           }}, "Log Out"),
           
           m('hr.border.my-8'),
           m("p", {class: 'tile'}, m('div',{class:'tile is-child box'},m(SearchBox))),
           
           m('hr.border.my-8'),
           
           m('div',{class: 'tile is-ancestor'},[
               m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(PostForm))),
        	   m("div", {class: 'tile'}, m('div',{class:'tile is-child box'},m(PostView))),
           ])
       ])
   }
}




m.mount(document.body, Hello)	


</script>
</body>
</html>